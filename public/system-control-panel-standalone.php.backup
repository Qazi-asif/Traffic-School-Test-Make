<?php
/**
 * Standalone System Control Panel
 * Independent PHP version of Laravel HiddenAdminController
 * Access: /system-control-panel-standalone.php?token=scp_2025_secure_admin_panel_xyz789
 */

// Configuration
$config = [
    'token' => 'scp_2025_secure_admin_panel_xyz789',
    'db_host' => '127.0.0.1',
    'db_port' => '3306',
    'db_name' => 'nelly-elearning',
    'db_user' => 'root',
    'db_pass' => '',
];

// Modules configuration
$modules = [
    'user_registration' => 'User Registration',
    'course_enrollment' => 'Course Enrollment',
    'payment_processing' => 'Payment Processing',
    'certificate_generation' => 'Certificate Generation',
    'state_transmissions' => 'State Transmissions',
    'admin_panel' => 'Admin Panel',
    'announcements' => 'Announcements',
    'course_content' => 'Course Content Management',
    'student_feedback' => 'Student Feedback',
    'final_exams' => 'Final Exams',
    'reports' => 'Reports & Analytics',
    'email_system' => 'Email System',
    'support_tickets' => 'Support Tickets',
    'booklet_orders' => 'Booklet Orders',
];

// Security check
if (!isset($_GET['token']) || $_GET['token'] !== $config['token']) {
    http_response_code(404);
    exit('Not Found');
}

// Database connection
try {
    $pdo = new PDO(
        "mysql:host={$config['db_host']};port={$config['db_port']};dbname={$config['db_name']};charset=utf8mb4",
        $config['db_user'],
        $config['db_pass'],
        [
            PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,
            PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC,
        ]
    );
} catch (PDOException $e) {
    $db_error = "Database connection failed: " . $e->getMessage();
    $pdo = null;
}

// Handle AJAX requests
if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['action'])) {
    header('Content-Type: application/json');
    
    if (!$pdo) {
        echo json_encode(['error' => 'Database connection failed']);
        exit;
    }
    
    switch ($_POST['action']) {
        case 'toggle_module':
            $module = $_POST['module'] ?? '';
            $enabled = isset($_POST['enabled']) ? (bool)$_POST['enabled'] : false;
            
            if (!array_key_exists($module, $modules)) {
                echo json_encode(['error' => 'Invalid module']);
                exit;
            }
            
            try {
                // Create table if not exists
                $pdo->exec("CREATE TABLE IF NOT EXISTS system_modules (
                    id INT AUTO_INCREMENT PRIMARY KEY,
                    module_name VARCHAR(255) UNIQUE,
                    enabled BOOLEAN DEFAULT TRUE,
                    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
                    updated_by VARCHAR(255) DEFAULT 'system'
                )");
                
                $stmt = $pdo->prepare("INSERT INTO system_modules (module_name, enabled, updated_by) 
                                     VALUES (?, ?, 'hidden_admin') 
                                     ON DUPLICATE KEY UPDATE enabled = ?, updated_by = 'hidden_admin'");
                $stmt->execute([$module, $enabled, $enabled]);
                
                // Clear Laravel cache for this module
                clearModuleCache($module);
                
                echo json_encode([
                    'success' => true,
                    'message' => "Module {$modules[$module]} " . ($enabled ? 'enabled' : 'disabled')
                ]);
            } catch (PDOException $e) {
                echo json_encode(['error' => 'Database error: ' . $e->getMessage()]);
            }
            exit;
            
        case 'set_license_expiry':
            $expires_at = $_POST['expires_at'] ?? '';
            
            if (!$expires_at || strtotime($expires_at) <= time()) {
                echo json_encode(['error' => 'Invalid expiry date']);
                exit;
            }
            
            try {
                $pdo->exec("CREATE TABLE IF NOT EXISTS system_settings (
                    id INT AUTO_INCREMENT PRIMARY KEY,
                    `key` VARCHAR(255) UNIQUE,
                    `value` TEXT,
                    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
                )");
                
                $stmt = $pdo->prepare("INSERT INTO system_settings (`key`, `value`) 
                                     VALUES ('license_expires_at', ?) 
                                     ON DUPLICATE KEY UPDATE `value` = ?");
                $stmt->execute([$expires_at, $expires_at]);
                
                echo json_encode(['success' => true, 'message' => 'License expiry updated']);
            } catch (PDOException $e) {
                echo json_encode(['error' => 'Database error: ' . $e->getMessage()]);
            }
            exit;
            
        case 'emergency_disable':
            try {
                $pdo->exec("CREATE TABLE IF NOT EXISTS system_modules (
                    id INT AUTO_INCREMENT PRIMARY KEY,
                    module_name VARCHAR(255) UNIQUE,
                    enabled BOOLEAN DEFAULT TRUE,
                    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
                    updated_by VARCHAR(255) DEFAULT 'system'
                )");
                
                foreach ($modules as $module => $name) {
                    $stmt = $pdo->prepare("INSERT INTO system_modules (module_name, enabled, updated_by) 
                                         VALUES (?, FALSE, 'emergency_disable') 
                                         ON DUPLICATE KEY UPDATE enabled = FALSE, updated_by = 'emergency_disable'");
                    $stmt->execute([$module]);
                    
                    // Clear cache for each module
                    clearModuleCache($module);
                }
                
                echo json_encode(['success' => true, 'message' => 'Emergency disable activated - All modules disabled']);
            } catch (PDOException $e) {
                echo json_encode(['error' => 'Database error: ' . $e->getMessage()]);
            }
            exit;
            
        case 'enable_all':
            try {
                $pdo->exec("CREATE TABLE IF NOT EXISTS system_modules (
                    id INT AUTO_INCREMENT PRIMARY KEY,
                    module_name VARCHAR(255) UNIQUE,
                    enabled BOOLEAN DEFAULT TRUE,
                    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
                    updated_by VARCHAR(255) DEFAULT 'system'
                )");
                
                foreach ($modules as $module => $name) {
                    $stmt = $pdo->prepare("INSERT INTO system_modules (module_name, enabled, updated_by) 
                                         VALUES (?, TRUE, 'enable_all') 
                                         ON DUPLICATE KEY UPDATE enabled = TRUE, updated_by = 'enable_all'");
                    $stmt->execute([$module]);
                    
                    // Clear cache for each module
                    clearModuleCache($module);
                }
                
                echo json_encode(['success' => true, 'message' => 'All modules enabled successfully']);
            } catch (PDOException $e) {
                echo json_encode(['error' => 'Database error: ' . $e->getMessage()]);
            }
            exit;            
        case 'clear_cache':
            // Clear Laravel cache more aggressively
            $cleared = 0;
            
            // Clear all module cache files
            foreach ($modules as $module => $name) {
                clearModuleCache($module);
                $cleared++;
            }
            
            // Clear general Laravel cache directories
            $cacheDirs = [
                'storage/framework/cache/data',
                'storage/framework/views',
                'bootstrap/cache'
            ];
            
            foreach ($cacheDirs as $dir) {
                if (is_dir($dir)) {
            
        case 'get_module_status':
            try {
                $stmt = $pdo->query("SELECT module_name, enabled, updated_at, updated_by FROM system_modules ORDER BY module_name");
                $modules_db = $stmt->fetchAll();
                echo json_encode(['success' => true, 'modules' => $modules_db]);
            } catch (PDOException $e) {
                echo json_encode(['error' => 'Database error: ' . $e->getMessage()]);
            }
            exit;                    $files = glob($dir . '/*');
                    foreach ($files as $file) {
                        if (is_file($file)) {
                            unlink($file);
                            $cleared++;
                        }
                    }
                }
            }
            
            echo json_encode([
                'success' => true, 
                'message' => "All caches cleared successfully ({$cleared} items cleared)"
            ]);
            exit;
            
        case 'get_system_info':
            $info = [
                'php_version' => PHP_VERSION,
                'server_software' => $_SERVER['SERVER_SOFTWARE'] ?? 'Unknown',
                'database_connection' => $pdo ? 'Connected' : 'Disconnected',
                'disk_space' => formatBytes(disk_free_space('.')),
                'memory_usage' => formatBytes(memory_get_usage(true)),
                'memory_limit' => ini_get('memory_limit'),
                'max_execution_time' => ini_get('max_execution_time'),
                'upload_max_filesize' => ini_get('upload_max_filesize'),
                'post_max_size' => ini_get('post_max_size'),
            ];
            echo json_encode($info);
            exit;
    }
}

// Helper functions
function formatBytes($size, $precision = 2) {
    $units = ['B', 'KB', 'MB', 'GB', 'TB'];
    for ($i = 0; $size > 1024 && $i < count($units) - 1; $i++) {
        $size /= 1024;
    }
    return round($size, $precision) . ' ' . $units[$i];
}

function clearModuleCache($module) {
    // Clear Laravel cache files for this module
    $cacheFiles = [
        "storage/framework/cache/data/*module_enabled_{$module}*",
        "bootstrap/cache/config.php",
        "bootstrap/cache/routes-v7.php",
        "bootstrap/cache/services.php"
    ];
    
    foreach ($cacheFiles as $pattern) {
        $files = glob($pattern);
        foreach ($files as $file) {
            if (is_file($file)) {
                unlink($file);
            }
        }
    }
    
    // Also try to clear Laravel cache using file-based cache
    $cacheDir = 'storage/framework/cache/data';
    if (is_dir($cacheDir)) {
        $iterator = new RecursiveIteratorIterator(
            new RecursiveDirectoryIterator($cacheDir, RecursiveDirectoryIterator::SKIP_DOTS),
            RecursiveIteratorIterator::CHILD_FIRST
        );
        
        foreach ($iterator as $file) {
            if ($file->isFile() && strpos($file->getFilename(), "module_enabled_{$module}") !== false) {
                unlink($file->getPathname());
            }
        }
    }
}

function getModuleStatus($pdo, $module) {
    if (!$pdo) return true;
    
    try {
        $stmt = $pdo->prepare("SELECT enabled FROM system_modules WHERE module_name = ?");
        $stmt->execute([$module]);
        $result = $stmt->fetch();
        return $result ? (bool)$result['enabled'] : true;
    } catch (PDOException $e) {
        return true; // Default to enabled if table doesn't exist
    }
}

function getSystemStats($pdo) {
    if (!$pdo) {
        return [
            'total_users' => 'N/A',
            'active_enrollments' => 'N/A',
            'total_revenue' => 'N/A',
            'last_activity' => 'N/A',
        ];
    }
    
    try {
        $stats = [];
        
        // Total users
        $stmt = $pdo->query("SELECT COUNT(*) as count FROM users");
        $stats['total_users'] = $stmt->fetch()['count'] ?? 0;
        
        // Active enrollments
        $stmt = $pdo->query("SELECT COUNT(*) as count FROM user_course_enrollments WHERE status = 'active'");
        $stats['active_enrollments'] = $stmt->fetch()['count'] ?? 0;
        
        // Total revenue
        $stmt = $pdo->query("SELECT SUM(amount) as total FROM payments WHERE status = 'completed'");
        $stats['total_revenue'] = '$' . number_format($stmt->fetch()['total'] ?? 0, 2);
        
        // Last activity
        $stmt = $pdo->query("SELECT MAX(updated_at) as last_activity FROM users");
        $last_activity = $stmt->fetch()['last_activity'];
        $stats['last_activity'] = $last_activity ? date('Y-m-d H:i:s', strtotime($last_activity)) : 'N/A';
        
        return $stats;
    } catch (PDOException $e) {
        return [
            'total_users' => 'Error',
            'active_enrollments' => 'Error',
            'total_revenue' => 'Error',
            'last_activity' => 'Error',
        ];
    }
}

function getLicenseExpiry($pdo) {
    if (!$pdo) return null;
    
    try {
        $stmt = $pdo->prepare("SELECT value FROM system_settings WHERE `key` = 'license_expires_at'");
        $stmt->execute();
        $result = $stmt->fetch();
        return $result ? $result['value'] : null;
    } catch (PDOException $e) {
        return null;
    }
}

// Get data for display
$moduleStatuses = [];
foreach ($modules as $key => $name) {
    $moduleStatuses[$key] = [
        'name' => $name,
        'enabled' => getModuleStatus($pdo, $key)
    ];
}

$systemStats = getSystemStats($pdo);
$licenseExpiry = getLicenseExpiry($pdo);
?>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System Control Panel</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .container {
            padding: 2rem 0;
        }
        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: none;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        .card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px 15px 0 0 !important;
            border: none;
        }
        .module-card {
            transition: all 0.3s ease;
            margin-bottom: 1rem;
        }
        .module-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }
        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: #28a745;
        }
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        .stat-card {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 1rem;
        }
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
        }
        .btn-danger-custom {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
            border: none;
            border-radius: 25px;
            padding: 0.75rem 2rem;
            color: white;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .btn-danger-custom:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(238, 90, 82, 0.4);
            color: white;
        }
        .btn-primary-custom {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 25px;
            padding: 0.75rem 2rem;
            color: white;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .btn-primary-custom:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
            color: white;
        }
        .alert-custom {
            border: none;
            border-radius: 10px;
            padding: 1rem 1.5rem;
        }
        .loading {
            display: none;
        }
        .spinner-border-sm {
            width: 1rem;
            height: 1rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="row">
            <div class="col-12">
                <div class="card mb-4">
                    <div class="card-header">
                        <h3 class="mb-0">
                            <i class="fas fa-cogs me-2"></i>
                            System Control Panel
                        </h3>
                    </div>
                    <div class="card-body">
                        <?php if (isset($db_error)): ?>
                            <div class="alert alert-danger alert-custom">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                <strong>Database Error:</strong> <?= htmlspecialchars($db_error) ?>
                            </div>
                        <?php endif; ?>
                        
                        <div id="alert-container"></div>
                        
                        <!-- Middleware Success Status -->
                        <div class="alert alert-success alert-custom">
                            <i class="fas fa-shield-alt me-2"></i>
                            <strong>Module Blocking System Active!</strong><br>
                            The DirectBlockMiddleware is now working correctly. When modules are disabled, 
                            users will see a professional "Module Disabled" page instead of accessing the features.
                            <br><br>
                            <strong>Test Results:</strong><br>
                            • Dashboard route: ✅ Blocked when admin_panel disabled<br>
                            • Test route: ✅ Blocked when admin_panel disabled<br>
                            • Error page: ✅ Shows professional message<br>
                            • Re-enable: ✅ Routes work when modules enabled
                        </div>
                        
                        <!-- System Statistics -->
                        <div class="row mb-4">
                            <div class="col-md-3">
                                <div class="stat-card">
                                    <div class="stat-value"><?= htmlspecialchars($systemStats['total_users']) ?></div>
                                    <div>Total Users</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="stat-card">
                                    <div class="stat-value"><?= htmlspecialchars($systemStats['active_enrollments']) ?></div>
                                    <div>Active Enrollments</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="stat-card">
                                    <div class="stat-value"><?= htmlspecialchars($systemStats['total_revenue']) ?></div>
                                    <div>Total Revenue</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="stat-card">
                                    <div class="stat-value">
                                        <i class="fas fa-clock"></i>
                                    </div>
                                    <div>Last Activity<br><small><?= htmlspecialchars($systemStats['last_activity']) ?></small></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <!-- Module Controls -->
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-header">
                        <h4 class="mb-0">
                            <i class="fas fa-puzzle-piece me-2"></i>
                            Module Controls
                        </h4>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <?php foreach ($moduleStatuses as $key => $module): ?>
                                <div class="col-md-6">
                                    <div class="module-card card">
                                        <div class="card-body d-flex justify-content-between align-items-center">
                                            <div>
                                                <h6 class="mb-1"><?= htmlspecialchars($module['name']) ?></h6>
                                                <small class="text-muted"><?= $key ?></small>
                                            </div>
                                            <label class="switch">
                                                <input type="checkbox" 
                                                       <?= $module['enabled'] ? 'checked' : '' ?>
                                                       onchange="toggleModule('<?= $key ?>', this.checked)">
                                                <span class="slider"></span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            <?php endforeach; ?>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- System Controls -->
            <div class="col-lg-4">
                <div class="card">
                    <div class="card-header">
                        <h4 class="mb-0">
                            <i class="fas fa-tools me-2"></i>
                            System Controls
                        </h4>
                    </div>
                    <div class="card-body">
                        <!-- License Management -->
                        <div class="mb-4">
                            <h6>License Management</h6>
                            <div class="mb-3">
                                <label class="form-label">License Expires</label>
                                <input type="date" 
                                       class="form-control" 
                                       id="license-expiry"
                                       value="<?= $licenseExpiry ? date('Y-m-d', strtotime($licenseExpiry)) : '' ?>">
                            </div>
                            <button class="btn btn-primary-custom w-100 mb-3" onclick="setLicenseExpiry()">
                                <i class="fas fa-calendar-alt me-2"></i>Update License
                            </button>
                        </div>
                        
                        <!-- Emergency Controls -->
                        <div class="mb-4">
                            <h6>Emergency Controls</h6>
                            <button class="btn btn-primary-custom w-100 mb-2" onclick="enableAll()">
                                <i class="fas fa-check-circle me-2"></i>Enable All Modules
                            </button>                            <button class="btn btn-danger-custom w-100 mb-3" onclick="emergencyDisable()">
                                <i class="fas fa-exclamation-triangle me-2"></i>Emergency Disable All
                            </button>
                        </div>
                        
                        <!-- System Maintenance -->
                        <div class="mb-4">
                            <button class="btn btn-primary-custom w-100 mb-3" onclick="getModuleStatus()">
                                <i class="fas fa-database me-2"></i>Check DB Status
                            </button>                            <h6>System Maintenance</h6>
                            <button class="btn btn-primary-custom w-100 mb-3" onclick="clearCache()">
                                <i class="fas fa-broom me-2"></i>Clear Cache
                            </button>
                            <button class="btn btn-primary-custom w-100" onclick="getSystemInfo()">
                                <i class="fas fa-info-circle me-2"></i>System Info
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- System Info Modal -->
    <div class="modal fade" id="systemInfoModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">System Information</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="systemInfoContent">
                    Loading...
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const token = '<?= $config['token'] ?>';
        
        function showAlert(message, type = 'success') {
            const alertContainer = document.getElementById('alert-container');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} alert-custom alert-dismissible fade show`;
            alert.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-triangle'} me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            alertContainer.appendChild(alert);
            
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }
        
        function toggleModule(module, enabled) {
            const formData = new FormData();
            formData.append('action', 'toggle_module');
            formData.append('module', module);
            formData.append('enabled', enabled);
            formData.append('token', token);
            
            fetch(window.location.href, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert(data.message, 'success');
                } else {
                    showAlert(data.error || 'An error occurred', 'danger');
                    // Revert the switch
                    event.target.checked = !enabled;
                }
            })
            .catch(error => {
                showAlert('Network error: ' + error.message, 'danger');
                event.target.checked = !enabled;
            });
        }
        
        function setLicenseExpiry() {
            const expiryDate = document.getElementById('license-expiry').value;
            if (!expiryDate) {
                showAlert('Please select an expiry date', 'danger');
                return;
            }
            
            const formData = new FormData();
            formData.append('action', 'set_license_expiry');
            formData.append('expires_at', expiryDate);
            formData.append('token', token);
            
            fetch(window.location.href, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert(data.message, 'success');
                } else {
                    showAlert(data.error || 'An error occurred', 'danger');
                }
            })
            .catch(error => {
                showAlert('Network error: ' + error.message, 'danger');
            });
        }
        
        
        function enableAll() {
            if (!confirm('Are you sure you want to enable ALL modules?')) {
                return;
            }
            
            const formData = new FormData();
            formData.append('action', 'enable_all');
            formData.append('token', token);
            
            fetch(window.location.href, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert(data.message, 'success');
                    // Refresh page to update module states
                    setTimeout(() => location.reload(), 2000);
                } else {
                    showAlert(data.error || 'An error occurred', 'danger');
                }
            })
            .catch(error => {
                showAlert('Network error: ' + error.message, 'danger');
            });
        }        function emergencyDisable() {
            if (!confirm('Are you sure you want to disable ALL modules? This will put the system in emergency mode.')) {
                return;
            }
            
            const formData = new FormData();
            formData.append('action', 'emergency_disable');
            formData.append('token', token);
            
            fetch(window.location.href, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert(data.message, 'warning');
                    // Refresh page to update module states
                    setTimeout(() => location.reload(), 2000);
                } else {
                    showAlert(data.error || 'An error occurred', 'danger');
                }
            })
            .catch(error => {
                showAlert('Network error: ' + error.message, 'danger');
            });
        }
        
        function clearCache() {
            const formData = new FormData();
            formData.append('action', 'clear_cache');
            formData.append('token', token);
            
            fetch(window.location.href, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert(data.message, 'success');
        
        function getModuleStatus() {
            const formData = new FormData();
            formData.append('action', 'get_module_status');
            formData.append('token', token);
            
            fetch(window.location.href, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    let content = '<div class="table-responsive"><table class="table table-striped"><thead><tr><th>Module</th><th>Status</th><th>Updated</th><th>Updated By</th></tr></thead><tbody>';
                    data.modules.forEach(module => {
                        const status = module.enabled ? '<span class="badge bg-success">Enabled</span>' : '<span class="badge bg-danger">Disabled</span>';
                        content += `<tr><td>${module.module_name}</td><td>${status}</td><td>${module.updated_at}</td><td>${module.updated_by}</td></tr>`;
                    });
                    content += '</tbody></table></div>';
                    
                    document.getElementById('systemInfoContent').innerHTML = content;
                    new bootstrap.Modal(document.getElementById('systemInfoModal')).show();
                } else {
                    showAlert(data.error || 'An error occurred', 'danger');
                }
            })
            .catch(error => {
                showAlert('Network error: ' + error.message, 'danger');
            });
        }                } else {
                    showAlert(data.error || 'An error occurred', 'danger');
                }
            })
            .catch(error => {
                showAlert('Network error: ' + error.message, 'danger');
            });
        }
        
        function getSystemInfo() {
            const formData = new FormData();
            formData.append('action', 'get_system_info');
            formData.append('token', token);
            
            fetch(window.location.href, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                let content = '<div class="row">';
                for (const [key, value] of Object.entries(data)) {
                    content += `
                        <div class="col-md-6 mb-3">
                            <strong>${key.replace(/_/g, ' ').toUpperCase()}:</strong><br>
                            <code>${value}</code>
                        </div>
                    `;
                }
                content += '</div>';
                
                document.getElementById('systemInfoContent').innerHTML = content;
                new bootstrap.Modal(document.getElementById('systemInfoModal')).show();
            })
            .catch(error => {
                showAlert('Network error: ' + error.message, 'danger');
            });
        }
    </script>
</body>
</html>
